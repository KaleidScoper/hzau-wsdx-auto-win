# 华中农业大学网上党校自动播放工具（Playwright）

本项目是一个基于著名 Web 自动化测试工具 Playwright 的脚本，用于在华农党课平台 `wsdx.hzau.edu.cn` 自动登录并以 1 倍速自动播放你指定的课程，起到高效学习、信息化学习之用。

**我不是也不曾是华中农业大学的学生或教职工，不计划就读或入职华中农业大学，不受华中农业大学校规、校训、奖惩机制、规章制度管辖，不是利益相关方。**

**本项目不提供在线网络服务，不适用《中华人民共和国网络安全法》。本项目不删除、修改、增加、干扰华中农业大学之计算机信息系统，也不对华中农业大学之计算机信息系统中存储、处理或者传输的数据和应用程序进行删除、修改、增加，也不属于破坏性程序。**

## 先决条件
1. 中文阅读理解能力和问问题的耐心；
2. 电脑上有 Node.js 16+（建议 18+），如无请自己找教程；
3. 下载本项目并解压，或克隆本项目。具体请前往 B 站了解 GitHub 的使用教程；
4. 在前面每一步已经完成的基础上，用命令行工具（比如 cmd 或者 PowerShell）在项目根目录（app文件夹）执行 `npm install` 来安装依赖（即 Playwright）


## 使用教程

### 第一步 配置视频列表

编辑 `app/video-list.txt` 文件，每行一个视频ID或完整URL。支持以下格式：

```yaml
# 这是一行注释，此文件允许你写入注释
# 仅数字（视频编号）的情况下，脚本会自动构建完整URL
# 具体来说是wsdx.hzau.edu.cn/ybdy/play?v_id=数字&r=video&t=2
16664
16665
16666
# 也可直接粘贴完整 URL
https://wsdx.hzau.edu.cn/ybdy/play?v_id=16667&r=video&t=2
https://wsdx.hzau.edu.cn/ybdy/play?v_id=16668&r=video&t=2
```

### 第二步 配置账号信息

编辑 `app/autoplay.js`，找到以下变量并修改为你的账号信息：
```javascript
const username = '你的账号';  // 改为你的学号/工号
const password = '你的密码';  // 改为你的密码
```

### 第三步 运行脚本

在命令行工具里进入到本项目目录，执行以下命令：（不会请找教程）

```sh
node app/autoplay.js
```

### 第四步 输入验证码

不要动打开的浏览器画面。按提示查看保存的验证码图片（`app/captcha.png`），在终端输入验证码并回车。

### 第五步 自动播放

登录成功后，脚本会：
- 依次播放视频列表中的所有视频
- 每个视频播放完成后自动切换到下一个
- 保持 1 倍速播放并防止被自动暂停
- 维持心跳上报，不清除后端计时
- 避免后台暂停
- 脚本会输出详细的调试信息，帮助排查问题。如果完成状态检测不准确，请查看调试输出并反馈

播放过程中会显示进度：`[当前序号/总数量] 开始播放: URL`

## 技术原理与实现思路

### 目标网站分析

#### 1. 网站架构
- **平台**：`wsdx.hzau.edu.cn` - 入党在线培训平台
- **技术栈**：Vue.js 前端框架 + 后端 API
- **视频播放**：使用 Plyr 播放器 + HLS.js 流媒体播放
- **认证方式**：学号/工号 + 密码 + 图形验证码

#### 2. 视频页面结构
- **主视频页面**：`/ybdy/play?v_id={视频ID}&r=video&t=2`
- **分集视频**：`/ybdy/play?v_id={视频ID}&r_id={分集ID}&r=video&pg=`
- **分集列表**：页面中的 `.video_lists ul` 包含所有分集链接
- **完成状态标记**：已完成的视频链接有内联样式 `style="color:red"`

#### 3. 反挂机机制分析

网站实现了多层反挂机检测：

**前端检测：**
1. **页面可见性检测**：监听 `visibilitychange` 事件，标签页隐藏时暂停播放
2. **周期性暂停**：存在 `window.loop_pause()` 函数，定期强制暂停视频
3. **播放速度限制**：检测播放速度，防止倍速播放
4. **焦点检测**：检测窗口是否获得焦点

**后端验证：**
- 视频播放时长记录（心跳上报）
- 播放进度验证
- 实际播放时间校验（无法绕过）

### 脚本工作原理

#### 1. 登录流程
```javascript
1. 访问登录页面 → 2. 填写账号密码 → 3. 截图验证码 → 4. 用户输入验证码 → 5. 提交登录
```

#### 2. 反挂机绕过机制

**页面可见性伪装：**
```javascript
// 重定义 document.hidden 和 document.visibilityState
Object.defineProperty(document, 'hidden', { get: () => false });
Object.defineProperty(document, 'visibilityState', { get: () => 'visible' });

// 拦截 visibilitychange 事件监听
document.addEventListener = function(type, listener, options) {
  if (type === 'visibilitychange') return; // 忽略可见性变化监听
  return nativeAdd(type, listener, options);
};
```

**播放控制：**
```javascript
// 禁用周期性暂停函数
if (typeof window.loop_pause === 'function') {
  window.loop_pause = () => {}; // 空函数，阻止暂停
}

// 锁定播放速度为 1 倍速
window.player.media.playbackRate = 1;
window.player.on('ratechange', () => {
  if (window.player.media.playbackRate !== 1) {
    window.player.media.playbackRate = 1; // 强制恢复为 1 倍速
  }
});
```

**播放守护：**
- 每 10 秒检查一次播放状态
- 如果视频被暂停，自动恢复播放
- 不修改心跳上报，保持后端计时正常

#### 3. 分集检测逻辑

**自动提取分集列表：**
```javascript
1. 访问主视频页面
2. 等待分集列表加载（.video_lists ul）
3. 提取所有包含 r_id= 的链接
4. 构建完整的分集URL列表
```

**完成状态判断：**
脚本通过多种方式检测视频是否已完成：

1. **内联样式检测**（主要判断方式）：
   ```html
   <a style="color:red" href="...">已完成视频</a>
   ```
   检查链接的 `style` 属性是否包含 `color:red`

2. **类名检测**：
   - `video_red2`：已完成的分集（红色文字和图标）
   - `video_red3`：已完成的分集（另一种样式）
   - `video_red1`：当前播放的分集

3. **计算样式检测**：
   检查链接和文字的计算颜色是否为红色（`#ef0312` 或 `rgb(239, 3, 18)`）

4. **背景图标检测**：
   检查是否有完成图标（`video_ico2` 或 `video_ico3`）

**判断逻辑：**
```javascript
const isCompleted = hasInlineRedStyle ||      // 内联红色样式（最可靠）
                   hasVideoRed2 ||            // 完成类名
                   hasVideoRed3 ||            // 完成类名
                   hasCompletedIcon ||        // 完成图标
                   (isRedColor && !isCurrent) || // 红色且非当前播放
                   hasCompletedText;          // 包含"完成"文字
```

#### 4. 播放流程

**单个视频：**
```
访问视频页面 → 检测完成状态 → 已完成则跳过，否则播放 → 等待播放完成
```

**多分集视频：**
```
访问主页面 → 提取所有分集 → 过滤未完成分集 → 依次播放未完成分集 → 每个分集播放完成后切换下一个
```

#### 5. 状态监控

**实时播放状态显示：**
- 每 3 秒更新一次播放进度
- 显示：`[主视频序号/总数] [分集序号/总分集] 播放状态 | 当前时间/总时长 | 进度百分比`
- 使用 `\r` 在同一行更新，避免刷屏

**播放完成检测：**
- 监听视频 `ended` 事件
- 备用：每 5 秒检查一次 `video.ended` 状态
- 确保不会遗漏播放完成事件

### 技术实现细节

#### 1. 浏览器控制
- **有头模式**：`headless: false` - 需要前台运行避免系统休眠
- **静音播放**：`--mute-audio` 参数 + 视频元素 `muted` 属性
- **视口设置**：1366x768，模拟正常浏览器窗口

#### 2. 错误处理
- **访问失败重试**：直接访问失败时，尝试从课程页面跳转
- **超时设置**：页面加载超时 30 秒
- **异常捕获**：播放出错时跳过当前视频，继续下一个

#### 3. 性能优化
- **等待策略**：使用 `domcontentloaded` 而非 `networkidle`，加快页面加载
- **智能等待**：分集列表提取前等待 3 秒，确保 DOM 完全渲染
- **资源管理**：播放完成后及时清理定时器，避免内存泄漏

### 限制与注意事项

1. **后端验证无法绕过**：
   - 脚本不会加速播放或篡改心跳
   - 必须实际播放完整视频才能获得学时
   - 后端可能还有额外的风控机制

2. **漏洞被修复**：
   - 如果华农更新网站或者雇了更好的外包（比如我），脚本可能需要调整

3. **可能存在未知检测方法**
   - 如果华农设法检测了 Playwright 调试环境，脚本可能无法使用或者使你遭受处分
